# 커넥션풀이 성능에 미치는 영향

## 커넥션 풀의 역할

커넥션 풀은 데이터베이스와 애플리케이션 간의 연결 비용을 줄이기 위해 고안되었습니다. 애플리케이션이 매번 새로운 연결을 생성하지 않고, 미리 생성된 연결을 재사용하여 성능을 최적화합니다.

- 적정한 풀 크기인 경우: 애플리케이션 요청이 효율적으로 처리됩니다.
- 과도한 풀 크기인 경우: 데이터베이스와 애플리케이션 모두에 과부하가 발생합니다.

## 커넥션 풀이 너무 많을 경우 생기는 문제

1. CPU 오버헤드 증가

데이터베이스가 동시에 처리할 수 있는 작업의 수는 CPU 코어 수와 비례합니다.  
커넥션 풀이 CPU 코어 수보다 훨씬 크다면, 데이터베이스는 과도한 컨텍스트 스위칭(context switching)으로 인해 처리 속도가 저하됩니다.

2. 메모리 부족

각 커넥션은 메모리와 리소스를 소비합니다. 커넥션 풀이 크면 메모리 소모가 증가하고, 가용 메모리가 부족해질 수 있습니다.  
이는 페이지 스와핑(page swapping)이나 OOM(Out of Memory) 문제를 초래합니다.

3. 디스크 I/O 병목

많은 커넥션이 동시에 데이터베이스와 디스크 I/O를 요청하면 디스크 I/O 대기 시간이 증가합니다.  
특히 디스크 속도가 상대적으로 느린 경우에 병목 현상이 두드러집니다.

4. 네트워크 대역폭

커넥션 수가 많을수록 네트워크 트래픽이 증가하여 대역폭을 초과할 가능성이 높아집니다.

5. Lock 경합 증가

데이터베이스는 동시 요청을 처리하기 위해 Lock을 사용합니다.  
커넥션 수가 많으면 Lock 경합이 증가하고, 쿼리 처리 시간이 길어질 수 있습니다.

## 왜 작은 커넥션 풀 크기가 더 좋을 수 있을까?

적절한 크기의 커넥션 풀은 요청을 **큐(Queue)**에 넣고, 제한된 리소스로 순차적으로 처리합니다.  
병렬 처리량을 과도하게 늘리지 않고, 시스템이 효율적으로 작동할 수 있는 환경을 제공합니다.  
Oracle과 PostgreSQL의 테스트 결과에서 보인 것처럼, 적은 커넥션 풀 크기가 대기 시간을 줄이고 시스템 자원을 효율적으로 활용합니다.

## default connection pool을 권장하는 이유

기본 커넥션 풀 크기는 일반적으로 데이터베이스 벤더들이 권장하는 최적 크기로 설정됩니다. 이는 다음과 같은 이유에서 중요한 역할을 합니다.

1. 시스템 리소스에 최적화됨

데이터베이스 벤더는 각 시스템의 평균 CPU, 메모리, 디스크 성능을 기준으로 기본값을 설정합니다.  
이 기본값은 대부분의 애플리케이션에서 무리가 없는 수준으로 설정됩니다.

2. 오버헤드 방지

기본값을 크게 초과하면 앞서 언급한 컨텍스트 스위칭, 메모리 부족, 디스크 I/O 병목 문제가 발생할 가능성이 높아집니다.

3. 애플리케이션 프로파일링 부족

커넥션 풀 크기를 변경하기 전에 애플리케이션의 트래픽 패턴과 데이터베이스의 병목 구간을 분석해야 하지만, 이를 하지 않고 단순히 숫자를 늘리는 것은 오히려 성능을 악화시킬 수 있습니다.

## Apache말고 Nginx가 뜬이유와의 관련성

### Apache의 동작 방식

Apache는 전통적으로 스레드 기반 동시성 모델을 사용합니다.  
요청마다 스레드(또는 프로세스)를 생성하여 처리합니다.  
요청이 많아질수록 스레드 수가 증가하며, 컨텍스트 스위칭과 메모리 소모가 커집니다.

### Nginx의 동작 방식

Nginx는 비동기 이벤트 기반 모델을 사용합니다.  
요청을 처리하기 위해 스레드 수를 크게 늘리지 않으며, 대신 단일 스레드에서 여러 요청을 비동기적으로 처리합니다.  
이는 메모리와 CPU 사용량을 줄이고, 높은 트래픽 환경에서도 효율적으로 동작할 수 있도록 해줍니다.

### 비교

Apache와 Nginx의 차이는 동시 요청 처리 방식에 있습니다.  
커넥션 풀 크기를 적정 수준으로 유지하는 것은 Nginx의 비동기 방식과 유사한 원리로 시스템의 안정성과 효율성을 높이는 데 기여합니다.

## 결론

시스템의 리소스(CPU, 메모리, 디스크 I/O)의 한계를 이해하고, 적정한 병렬성을 유지할 수 있도록 적정한 커넥션 풀 크기를 유지하고, 필요 시 애플리케이션의 트래픽 패턴에 맞게 프로파일링을 통해 조정하면 서버의 성능이 향상될 것이다.

---

## 참고

[psql과 connection pool](https://maily.so/devpill/posts/e9o02g3ez8w)
