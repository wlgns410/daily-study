# collation sort 문제

다국어 지원 개발을 하면서 한글 정렬이 이상하게 되는 문제를 발견했다.

ko_KR.UTF-8로 설정해도 일부 한글 정렬이 의도한 대로 동작하지 않았다.  
이 문제는 PostgreSQL이나 MySQL 같은 데이터베이스에서 한글의 초성/중성/종성 순서를 고려하지 못해 발생한 케이스였다.

![이미지 출처 : jupiny 블로그](/asset/sort-collation.png)

## collate

`psql`에서는 `collate`라는 컬럼이 있다.  
collation은 인코딩 방식에 따라 데이터의 정렬 순서를 결정한다.  
보통 데이터베이스를 생성하면 기본적으로 `ko_KR.UTF-8` 또는 `en_US.UTF-8`로 설정되지만, 정렬 문제를 피하려면 `LC_COLLATE` 값을 `'C'`로 설정해야 한다.  
다만, 이미 생성된 데이터베이스에서는 이 값을 수정할 수 없으므로, 새로운 데이터베이스를 생성하고 데이터를 덤프 및 로드하는 작업이 필요하다.  
이 문제는 MySQL에서도 동일하게 발생하므로 미리 'C'로 만들었는지 확인하고 많은 작업을 하기전에 바꾸던가 해야한다... 아니면 나중에 엄청 귀찮아질 수 있다.

![c collation](/asset/c-collation.png)

위처럼 `C.UTF-8`로 설정되게 한다.  
C.UTF-8은 C collation을 기반으로 하면서 UTF-8 인코딩을 사용하고 있는 설정을 말한다.

## 장점

1. 성능 향상: C collation은 복잡한 로케일 계산을 하지 않기 때문에 성능이 향상될 수 있다. 즉, 정렬이 많이 필요한 도메인이면 성능상 이점이 될 수 있다.
2. 일관된 유니코드 순서: C collation은 한글을 포함한 모든 문자를 유니코드 순서대로 정렬하므로, 일부 로케일에서 발생하는 예기치 않은 정렬 문제를 방지한다.
3. 예측 가능성: 언어별 규칙 없이 코드 포인트 순서대로 정렬하므로, 한글과 같은 다중 초성/중성 체계에서도 예측 가능한 순서를 얻을 수 있다.

## 결론

ko_KR.UTF-8이 한글 정렬을 완벽히 처리하지 못할 경우, C collation으로 바꿔 유니코드 정렬을 하게 된다면 한글과 같은 다중 초성/중성 체계 방식 언어에 정렬하기 좋을 수 있다.

---

참고  
[PostgreSQL에서 한국어 정렬 문제 해결하기](https://jupiny.com/2016/12/12/sort-korean-in-postgresql/)
