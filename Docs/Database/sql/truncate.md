# truncate 와 delete

## TRUNCATE

- 테이블의 모든 데이터를 빠르게 삭제.
- 기본적으로 롤백 로그를 최소화하여 성능이 매우 빠름.
- 테이블을 잠그기 때문에, 동작 중 다른 트랜잭션에서 접근할 수 없음 (DDL 락).
- **외래 키(Foreign Key)**가 설정된 경우 기본적으로 제한되지만, CASCADE 옵션을 사용하면 참조 관계의 데이터를 삭제할 수 있음.

```
빠른 데이터 삭제가 가능하며 CASCADE를 통해 참조 관계까지 한 번에 처리할 수 있음
단, 삭제된 데이터는 복구 불가 (단, 트랜잭션 내에서는 롤백 가능)
```

### TRUNCATE의 CASCADE 옵션

`TRUNCATE TABLE items CASCADE` 를 실행하면

- items 테이블의 모든 데이터를 삭제가능
- items 테이블과 외래 키로 연결된 테이블의 데이터도 삭제가능(참조 데이터도 제거)
- 의존 관계(뷰, 규칙 등)가 있는 경우에도 삭제가능

## DELETE

- 조건에 따라 데이터 삭제 가능 (WHERE 절 사용 가능).
- 모든 행을 삭제하는 경우 롤백 로그가 크고 느림.
- 외래 키로 연결된 테이블의 데이터가 있다면 기본적으로 제한(외래 키 제약 조건) 때문에 삭제 불가.

```
선택적으로 데이터 삭제 가능하며 트리거(trigger)와 연동도 가능함
단, 대량의 데이터를 삭제할 때 느리고 참조 관계의 데이터 삭제가 어렵거나 추가 작업 필요함
```

### 왜 DELETE로는 안 되는가?

`DELETE FROM items`를 실행하면 외래 키 제약 조건(REFERENCES)이 걸려 있으면 삭제가 제한됨

- PostgreSQL은 외래 키 관계에서 참조 무결성을 유지하기 위해, 기본적으로 부모 데이터 삭제를 제한함
- 삭제가 가능하려면, 외래 키 제약 조건을 추가 설정해야 함

```
ON DELETE CASCADE: 부모 데이터 삭제 시 참조 데이터 자동 삭제.
ON DELETE SET NULL: 부모 데이터 삭제 시 참조 데이터의 외래 키 값을 NULL로 설정.
```

### 의존성 관계와 TRUNCATE

뷰(View)와 규칙(Rules)이 있을 것이다.  
TRUNCATE는 기본적으로 테이블만 처리하지만, CASCADE를 사용하면 해당 테이블과 연결된 뷰나 규칙도 삭제되어버린다.

```
CREATE VIEW items_view AS SELECT * FROM items;

TRUNCATE TABLE items CASCADE; // items_view는 더 이상 동작하지 않게 되고 제거됨
```

### TRUNCATE 주의점

1. 락 발생

```
TRUNCATE는 테이블을 잠그며, 다른 트랜잭션에서 해당 테이블에 접근할 수 없음
락 수준: ACCESS EXCLUSIVE (가장 높은 수준의 락)임
트리거(Triggers) 비활성화시킴

TRUNCATE는 테이블에서 설정된 트리거를 실행않음
트리거가 실행되어야 하는 작업이라면 DELETE를 사용해서 데이터를 제거해야함.
또한 데이터 복구 불가

TRUNCATE는 데이터를 빠르게 삭제하므로, 삭제된 데이터를 복구하려면 트랜잭션 내에서 사용하거나 사전 백업이 필요함
```
