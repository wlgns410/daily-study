# ec2 메모리 누수로 인한 서버 다운 현상

EC2 인스턴스를 중지했다가 다시 시작했을 때 서버가 정상적으로 돌아오는 이유는 리소스 누수나 시스템 상태에 문제가 있다.  
EC2를 재시작하면서 이를 초기화했기 때문일 가능성이 높다.  


## 원인 분석

1. 메모리 누수

- 애플리케이션에서 **메모리 누수(memory leak)**가 발생해, 실행 중 시간이 지남에 따라 서버의 사용 가능한 메모리가 줄어들었을 가능성이 있습니다.
- 메모리 누수가 있으면 새로운 요청을 처리할 메모리가 부족해지거나, 운영 체제가 프로세스를 강제로 종료할 수 있습니다 (OOM: Out of Memory). 따라서 EC2 인스턴스를 재시작하면 메모리가 초기화되므로, 이런 문제가 사라져 서버가 정상 동작하게 됩니다.

2. 파일 핸들 누수

- 서버 애플리케이션이 파일, 소켓, 데이터베이스 연결 같은 리소스를 열고 닫지 않는 상태가 누적되면 **파일 핸들(file descriptors)**이 고갈될 수 있습니다.
- 리소스가 고갈되면 새로운 연결을 수락하지 못하거나, 파일 읽기/쓰기 작업이 실패할 수 있는데, 인스턴스를 재시작하면 이런 리소스도 초기화됩니다.

3. 네트워크 연결 문제
   
- 오래된 TCP 소켓 연결이나 DB 커넥션 풀 누수로 인해 서버가 정상적으로 네트워크 요청을 처리하지 못할 가능성이 있습니다.
- 네트워크 연결 누수가 있다면 데이터베이스나 외부 API와의 연결이 실패하거나, 클라이언트 요청이 대기 상태에서 응답을 받지 못할 수 있습니다. 그래서 EC2를 재시작하면 네트워크 연결이 재설정됩니다.

4. 디스크 I/O 문제

- 디스크 사용량이 많거나, 로그 파일이 계속 쌓여 디스크가 꽉 찬 경우 서버가 비정상적으로 동작할 수 있습니다.
- 디스크 공간이 부족하면 애플리케이션 로그 작성 실패, 캐시나 임시 파일 저장 실패 등이 발생할 수 있습니다. 따라서 EC2 재시작 시 일부 임시 디렉토리가 초기화되거나, 프로세스가 새롭게 시작되면서 이런 문제가 해소됩니다.

## 확인방안

1. 시스템 로그 확인

`/var/log/syslog`, `/var/log/messages`, `/var/log/cloud-init.log` 등 시스템 로그를 확인해 시스템 상태나 에러 메시지를 확인합니다.

2. 애플리케이션 로그

애플리케이션 로그를 확인해 메모리 누수, 파일 핸들 누수, 네트워크 연결 문제, 디스크 I/O 문제 등을 확인합니다.

3. CPU 및 메모리 사용량 추적

```sql

top
free -h

```

4. 모니터링 도구 사용

CloudWatch, Datadog, New Relic 등 모니터링 도구를 사용해 서버의 CPU, 메모리, 네트워크, 디스크 I/O 사용량을 실시간으로 모니터링하고, 임계치를 넘어가는 경우 알림을 받아 대비를 합니다.

## 결론

- EC2 인스턴스를 중지 후 다시 시작했을 때 문제가 해결되는 이유는 메모리 누수, 파일 핸들 누수, 네트워크 연결 누적 등으로 인해 리소스가 고갈되었기 때문일 가능성을 생각해야합니다.
- 문제를 근본적으로 해결하려면 애플리케이션과 서버 리소스 사용 상태를 점검하고, 누수나 설정 문제를 수정해야 합니다.
- AWS CloudWatch와 로그, 모니터링 툴을 활용해 문제의 정확한 원인을 추적하고, 필요 시 자동 복구를 설정해 안정성을 높혀야합니다.
